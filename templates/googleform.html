<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>アンケートフォーム</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .id-container { margin-bottom: 20px; }
    .id-box {
      background-color: #f8f9fa; border: 1px solid #ccc;
      padding: 10px 15px; font-size: 1.2rem; display: inline-block;
      margin-right: 10px; user-select: all;
    }
    .copy-btn { padding: 8px 12px; font-size: 1rem; cursor: pointer; }
    iframe { width: 100%; height: 1200px; border: none; }
    /* トースト */
    #toast {
      visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
      text-align: center; border-radius: 6px; padding: 12px; position: fixed; z-index: 1000;
      right: 30px; bottom: 30px; font-size: 1rem; opacity: 0;
      transition: visibility 0s, opacity 0.5s ease-in-out;
    }
    #toast.show { visibility: visible; opacity: 1; }
  </style>
</head>
<body>
  <h1>質問項目にご回答ください</h1>
  <p>以下の「参加者ID」をフォームの最初の質問欄に<strong>コピー＆ペースト</strong>してください：</p>

  <div class="id-container">
    <span id="participantId" class="id-box">{{ participant_id }}</span>
    <button class="copy-btn btn btn-outline-primary" onclick="copyToClipboard()">コピー</button>
  </div>

  <!-- Googleフォーム埋め込み（必ず embedded=true ／ IDプリフィル） -->
  <iframe
    {% if from_previous == "1" %}
      src="https://docs.google.com/forms/d/e/1FAIpQLSd0TkOXznJVuVu3XWKO7Dg345-Lq6KpsbVguTVXUsVAsIzdsw/viewform?embedded=true&entry.1835875661={{ participant_id }}"
    {% else %}
      src="https://docs.google.com/forms/d/e/1FAIpQLSdnPpXp-e_C7Ou1ZtQ3U7iyPYjIGcZwBI-aXAiAGZw9RH848g/viewform?embedded=true&entry.1835875661={{ participant_id }}"
    {% endif %}
    id="form-frame"
  >読み込んでいます…</iframe>

  <!-- 回答完了ポップアップ（body内に配置） -->
  <div class="modal fade" id="afterSubmitModal" tabindex="-1" aria-hidden="true" aria-labelledby="afterSubmitTitle">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="afterSubmitTitle">回答の送信を確認しました</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          アンケートの送信を検知しました。次のステップへ進めます。
        </div>
        <div class="modal-footer">
          <a class="btn btn-primary" href="/guard_to_next">次へ進む</a>
        </div>
      </div>
    </div>
  </div>

  <!-- 予備導線：自動ポップアップが出ない時の手動ボタン（既定は非表示） -->
  <div id="next-section" style="display:none">
    <hr/>
    <h3>質問項目にご回答いただいた方は、次のステップにお進みください：</h3>
    <p class="text-muted mt-2">
      フォームは全部で5〜6ページございます。必ず<strong class="text-danger">「回答を記録しました」</strong>と表示されるまで回答をお願いします。
    </p>
    {% if session.get("from_previous") == "1" %}
      <form method="GET" action="{{ url_for('finish') }}" onsubmit="return confirmSubmit();">
    {% else %}
      <form method="GET" action="https://experiment-site-1j72.onrender.com/" onsubmit="return confirmSubmit();">
    {% endif %}
      <input type="hidden" name="from_previous" value="1"/>
      <input type="hidden" name="participant_id" value="{{ participant_id }}"/>
      <input type="hidden" name="condition" value="{{ session.get('condition','') }}"/>
      <button type="submit" class="btn btn-secondary">（予備）次のステップへ進む</button>
    </form>
  </div>

  <div id="toast">IDをコピーしました！</div>

  <!-- Bootstrap JS（必ず本スクリプトより前に読み込む） -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // クリップボード
    function copyToClipboard() {
        const idText = document.getElementById("participantId").innerText;
        navigator.clipboard.writeText(idText).then(showToast, () => alert("コピーに失敗しました"));
    }
    function showToast() {
        const toast = document.getElementById("toast");
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
    }
    function confirmSubmit() {
        return confirm(
        "質問項目への回答は完了していますか？\n" +
        "フォームは全部で5から6ページございます。\n" +
        "必ず「回答を記録しました」と表示されるまで回答をお願いします。\n" +
        "未回答のまま進むとデータが記録されません。"
        );
    }
     // ---- 回答完了ポーリング（絶対URLで） ----

  document.addEventListener("DOMContentLoaded", () => {
    const pid = "{{ participant_id }}";
    const expect = "{{ expect_form }}";   // "form1" or "form2"
    const baseUrl = window.location.origin;
    let popped = false;

    async function pollSubmit() {
      try {
        // ★ 必ずバッククォート（テンプレートリテラル）で
        const url = `${baseUrl}/form_status/${encodeURIComponent(pid)}?expect=${encodeURIComponent(expect)}`;
        console.log("Polling:", url);

        const res = await fetch(url, { cache: "no-store" });
        const ct = res.headers.get("content-type") || "";
        if (!ct.includes("application/json")) throw new Error("non-json response");
        const data = await res.json();
        console.log("Form status:", data);

        if (data.done && !popped) {
          popped = true;
          const modalEl = document.getElementById('afterSubmitModal');
          if (modalEl) new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false }).show();
          const fallback = document.getElementById('next-section');
          if (fallback) fallback.style.display = 'block';
          return; // stop polling
        }
      } catch (e) {
        console.warn("Polling error:", e);
      }
      setTimeout(pollSubmit, 3000);
    }

    pollSubmit();
  });
  </script>
</body>
</html>
