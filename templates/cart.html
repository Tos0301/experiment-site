<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚«ãƒ¼ãƒˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .cart-image {
            width: 80px;
            height: auto;
        }
    </style>

    <script>
        window.onload = function () {
            updateTotal();
        };

        function updateSubtotalAndSave(productId, price) {
            const quantityInput = document.getElementById('quantity_' + productId);
            const quantity = parseInt(quantityInput.value) || 0;

            // å°è¨ˆè¡¨ç¤ºã‚’æ›´æ–°
            const subtotal = price * quantity;
            document.getElementById('subtotal_' + productId).innerText = 'Â¥' + subtotal;
            updateTotal();

            // è‡ªå‹•ä¿å­˜ï¼ˆPOSTã§æ›´æ–°ï¼‰
            const formData = new URLSearchParams();
            formData.append('quantity_' + productId, quantity);

            fetch('/update_cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            }).then(response => {
                if (!response.ok) {
                    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            });
        }

        function updateTotal() {
            let total = 0;
            const subtotals = document.getElementsByClassName('subtotal');
            for (let elem of subtotals) {
                total += parseInt(elem.innerText.replace('Â¥', '')) || 0;
            }
            document.getElementById('total').innerText = 'åˆè¨ˆé‡‘é¡ï¼šÂ¥' + total;
        }
    </script>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="mb-4 text-center">ğŸ›’ ã‚«ãƒ¼ãƒˆã®ä¸­èº«</h1>

        {% if cart_items %}
        <table class="table table-bordered align-middle text-center bg-white">
            <thead class="table-secondary">
                <tr>
                    <th>å•†å“</th>
                    <th>æ•°é‡</th>
                    <th>å°è¨ˆ</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td class="text-start">
                        <div class="d-flex align-items-center gap-3">
                            <img src="{{ url_for('static', filename='images/' + item.image) }}"
                                 alt="{{ item.name }}" class="cart-image">
                            <span>{{ item.name }}</span>
                        </div>
                    </td>
                    <td>
                        <input type="number"
                               name="quantity_{{ item.id }}"
                               id="quantity_{{ item.id }}"
                               value="{{ item.quantity }}"
                               min="0"
                               class="form-control text-center"
                               onchange="updateSubtotalAndSave('{{ item.id }}', {{ item.price }})">
                    </td>
                    <td>
                        <span class="subtotal" id="subtotal_{{ item.id }}">Â¥{{ item.subtotal }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <p id="total" class="fs-5 text-end fw-bold me-2">åˆè¨ˆé‡‘é¡ï¼š</p>

        <div class="d-flex justify-content-end">
            <a href="/confirm" class="btn btn-success">ç¢ºèªç”»é¢ã¸é€²ã‚€</a>
        </div>
        {% else %}
        <div class="alert alert-warning text-center" role="alert">
            ã‚«ãƒ¼ãƒˆã¯ç¾åœ¨ç©ºã§ã™ã€‚
        </div>
        {% endif %}

        <div class="mt-4 text-center">
            <a href="/" class="btn btn-outline-secondary">â† å•†å“ä¸€è¦§ã¸æˆ»ã‚‹</a>
        </div>
    </div>
</body>
</html>
